<?php

namespace App\Controllers;

use App\Models\ProyectoModel;
use App\Models\ProyectoSeccionModel;
use App\Models\ProyectoGaleriaModel;

class Proyectos extends BaseController
{
    protected $proyectoModel;
    protected $seccionModel;
    protected $galeriaModel;
    
    public function __construct()
    {
        $this->proyectoModel = new ProyectoModel();
        $this->seccionModel = new ProyectoSeccionModel();
        $this->galeriaModel = new ProyectoGaleriaModel();
        helper(['form', 'url', 'filesystem']);
    }
    
    // Verificar que el usuario sea admin
    private function verificarAdmin()
    {
        if (!session()->has('usuario_id') || session()->get('usuario_rol') != 'admin') {
            return redirect()->to('/auth/login')->with('error', 'Acceso denegado');
        }
        return null;
    }

    /**
 * Portfolio para visitantes autenticados
 */
// public function portfolio()
// {
//     if (!session()->has('usuario_id')) {
//         return redirect()->to('/auth/login')->with('error', 'Debes iniciar sesión');
//     }
    
//     $proyectos = $this->proyectoModel->listarProyectosAutenticados();
    
//     $data = [
//         'titulo' => 'Portfolio de Proyectos',
//         'proyectos' => $proyectos,
//         'esAdmin' => session()->get('usuario_rol') == 'admin'
//     ];
    
//     return view('proyectos/portfolio', $data);
// }


// /**
//  * Ver detalle (visitantes autenticados)
//  */
// public function detalle($id)
// {
//     if (!session()->has('usuario_id')) {
//         return redirect()->to('/auth/login');
//     }
    
//     $proyecto = $this->proyectoModel->getProyectoCompleto($id);
    
//     if (!$proyecto) {
//         return redirect()->to('/proyectos/portfolio')->with('error', 'Proyecto no encontrado');
//     }
    
//     $usuarioRol = session()->get('usuario_rol');
//     $puedeVer = $this->proyectoModel->puedeVer($id, $usuarioRol, true);
    
//     if (!$puedeVer) {
//         return redirect()->to('/proyectos/portfolio')->with('error', 'No tienes permiso');
//     }
    
//     $data = [
//         'titulo' => $proyecto['nombre'],
//         'proyecto' => $proyecto,
//         'esAdmin' => $usuarioRol == 'admin'
//     ];
    
//     return view('proyectos/detalle', $data);
// }

/**
 * Portfolio PÚBLICO (sin autenticación)
 */
public function publico()
{
    $proyectos = $this->proyectoModel->listarProyectosPublicos();
    
    $data = [
        'titulo' => 'Nuestros Proyectos',
        'proyectos' => $proyectos
    ];
    
    return view('proyectos/publico', $data);
}

/**
 * Detalle público (sin autenticación)
 */
public function publicoDetalle($id)
{
    $proyecto = $this->proyectoModel->getProyectoCompleto($id);
    
    if (!$proyecto || $proyecto['estado'] !== 'publicado' || $proyecto['visibilidad'] !== 'publico') {
        return redirect()->to('/proyectos/publico')->with('error', 'Proyecto no disponible');
    }
    
    $data = [
        'titulo' => $proyecto['nombre'],
        'proyecto' => $proyecto
    ];
    
    return view('proyectos/publico_detalle', $data);
}

/**
 * Cambiar estado (AJAX)
 */
public function cambiarEstado($id)
{
    $redirect = $this->verificarAdmin();
    if ($redirect) return $redirect;
    
    $nuevoEstado = $this->request->getPost('estado');
    
    if (!in_array($nuevoEstado, ['borrador', 'publicado', 'archivado'])) {
        return $this->response->setJSON(['success' => false, 'message' => 'Estado inválido']);
    }
    
    if ($this->proyectoModel->cambiarEstado($id, $nuevoEstado)) {
        return $this->response->setJSON(['success' => true, 'message' => 'Estado cambiado']);
    }
    
    return $this->response->setJSON(['success' => false, 'message' => 'Error']);
}

/**
 * Cambiar visibilidad (AJAX)
 */
public function cambiarVisibilidad($id)
{
    $redirect = $this->verificarAdmin();
    if ($redirect) return $redirect;
    
    $nuevaVisibilidad = $this->request->getPost('visibilidad');
    
    if (!in_array($nuevaVisibilidad, ['privado', 'autenticado', 'publico'])) {
        return $this->response->setJSON(['success' => false, 'message' => 'Visibilidad inválida']);
    }
    
    if ($this->proyectoModel->cambiarVisibilidad($id, $nuevaVisibilidad)) {
        return $this->response->setJSON(['success' => true, 'message' => 'Visibilidad cambiada']);
    }
    
    return $this->response->setJSON(['success' => false, 'message' => 'Error']);
}

    /**
 * Listar proyectos ACTIVOS (Vista pública para visitantes)
 */
public function portfolio()
{
    // Verificar que el usuario esté autenticado
    if (!session()->has('usuario_id')) {
        return redirect()->to('/auth/login')->with('error', 'Debes iniciar sesión para ver el portfolio');
    }
    
    // Solo proyectos activos para visitantes
    $proyectos = $this->proyectoModel->listarProyectosActivos();
    
    $data = [
        'titulo' => 'Portfolio de Proyectos',
        'proyectos' => $proyectos,
        'esAdmin' => session()->get('usuario_rol') == 'admin'
    ];
    
    return view('proyectos/portfolio', $data);
}

/**
 * Ver proyecto completo (Vista pública)
 */
public function detalle($id)
{
    // Verificar que el usuario esté autenticado
    if (!session()->has('usuario_id')) {
        return redirect()->to('/auth/login')->with('error', 'Debes iniciar sesión');
    }
    
    $proyecto = $this->proyectoModel->getProyectoCompleto($id);
    
    if (!$proyecto) {
        return redirect()->to('/proyectos/portfolio')->with('error', 'Proyecto no encontrado');
    }
    
    // Si no es admin y el proyecto está inactivo, no mostrar
    if (session()->get('usuario_rol') != 'admin' && $proyecto['activo'] == 0) {
        return redirect()->to('/proyectos/portfolio')->with('error', 'Proyecto no disponible');
    }
    
    $data = [
        'titulo' => $proyecto['nombre'],
        'proyecto' => $proyecto,
        'esAdmin' => session()->get('usuario_rol') == 'admin'
    ];
    
    return view('proyectos/detalle', $data);
}
    
    // Listar proyectos
    public function index()
{
    $redirect = $this->verificarAdmin();
    if ($redirect) return $redirect;
    
    // Filtros
    $filtroEstado = $this->request->getGet('estado');
    $filtroVisibilidad = $this->request->getGet('visibilidad');
    
    if ($filtroEstado) {
        $proyectos = $this->proyectoModel->listarPorEstado($filtroEstado);
    } elseif ($filtroVisibilidad) {
        $proyectos = $this->proyectoModel->listarPorVisibilidad($filtroVisibilidad);
    } else {
        $proyectos = $this->proyectoModel->listarTodosProyectos();
    }
    
    // Estadísticas
    $estadisticas = [
        'estados' => $this->proyectoModel->contarPorEstado(),
        'visibilidades' => $this->proyectoModel->contarPorVisibilidad()
    ];
    
    $data = [
        'titulo' => 'Gestión de Proyectos',
        'proyectos' => $proyectos,
        'estadisticas' => $estadisticas,
        'filtroActual' => $filtroEstado ?: $filtroVisibilidad ?: 'todos'
    ];
    
    return view('proyectos/index', $data);
}
    
    // Ver proyecto completo
    public function ver($id)
    {
        $redirect = $this->verificarAdmin();
        if ($redirect) return $redirect;
        
        $proyecto = $this->proyectoModel->getProyectoCompleto($id);
        
        if (!$proyecto) {
            return redirect()->to('/proyectos')->with('error', 'Proyecto no encontrado');
        }
        
        $data = [
            'titulo' => 'Ver Proyecto: ' . $proyecto['nombre'],
            'proyecto' => $proyecto
        ];
        
        return view('proyectos/ver', $data);
    }
    
    // Crear proyecto - mostrar formulario
    public function crear()
    {
        $redirect = $this->verificarAdmin();
        if ($redirect) return $redirect;
        
        $data = [
            'titulo' => 'Crear Proyecto'
        ];
        
        return view('proyectos/crear', $data);
    }
    
    // Guardar proyecto nuevo
    public function guardar()
    {
        $redirect = $this->verificarAdmin();
        if ($redirect) return $redirect;
        
        $validation = \Config\Services::validation();
        
        $rules = [
            'nombre' => 'required|min_length[3]|max_length[255]',
            'descripcion' => 'required',
            'estado' => 'required|in_list[borrador,publicado,archivado]',        // ← NUEVO
            'visibilidad' => 'required|in_list[privado,autenticado,publico]',   // ← NUEVO
            'imagen_principal' => 'uploaded[imagen_principal]|max_size[imagen_principal,5120]|is_image[imagen_principal]'
        ];
        
        if (!$this->validate($rules)) {
            return redirect()->back()->withInput()->with('errors', $validation->getErrors());
        }
        
        // Procesar imagen principal
        $imagenPrincipal = $this->request->getFile('imagen_principal');
        $nombreImagen = null;
        
        if ($imagenPrincipal && $imagenPrincipal->isValid()) {
            $nombreImagen = $imagenPrincipal->getRandomName();
            $imagenPrincipal->move(WRITEPATH . '../public/uploads/proyectos', $nombreImagen);
        }
        
        // Guardar proyecto
        $data = [
            'nombre' => $this->request->getPost('nombre'), 
            'imagen_principal' => $nombreImagen,
            'descripcion' => $this->request->getPost('descripcion'),
            'estado' => $this->request->getPost('estado'),          // ← NUEVO
            'visibilidad' => $this->request->getPost('visibilidad'), // ← NUEVO
            'caso_estudio' => $this->request->getPost('caso_estudio'),
            'cliente' => $this->request->getPost('cliente'),
            'anio' => $this->request->getPost('anio'),
            'activo' => 1
        ];
        
        $proyectoId = $this->proyectoModel->insert($data);
        
        if ($proyectoId) {
            // Guardar secciones si existen
            $this->guardarSecciones($proyectoId);
            
            // Guardar galería si existe
            $this->guardarGaleria($proyectoId);
            
            return redirect()->to('/proyectos')->with('success', 'Proyecto creado correctamente');
        }
        
        return redirect()->back()->withInput()->with('error', 'Error al crear el proyecto');
    }
    
    // Editar proyecto - mostrar formulario
    public function editar($id)
    {
        $redirect = $this->verificarAdmin();
        if ($redirect) return $redirect;
        
        $proyecto = $this->proyectoModel->getProyectoCompleto($id);
        
        if (!$proyecto) {
            return redirect()->to('/proyectos')->with('error', 'Proyecto no encontrado');
        }
        
        $data = [
            'titulo' => 'Editar Proyecto: ' . $proyecto['nombre'],
            'proyecto' => $proyecto,
            //'estado' => $this->request->getPost('estado'),          
            //'visibilidad' => $this->request->getPost('visibilidad') 
        ];
        
        return view('proyectos/editar', $data);
    }
    
    // Actualizar proyecto
    public function actualizar($id)
    {
        $redirect = $this->verificarAdmin();
        if ($redirect) return $redirect;
        
        $proyecto = $this->proyectoModel->find($id);
        
        if (!$proyecto) {
            return redirect()->to('/proyectos')->with('error', 'Proyecto no encontrado');
        }
        
        $rules = [
            'nombre' => 'required|min_length[3]|max_length[255]',
            'descripcion' => 'required',
            'estado' => 'required|in_list[borrador,publicado,archivado]',        
            'visibilidad' => 'required|in_list[privado,autenticado,publico]', 
            'estado' => $this->request->getPost('estado'),          // ← NUEVO
            'visibilidad' => $this->request->getPost('visibilidad'), // ← NUEVO  
        ];
        
        // Validar imagen solo si se sube una nueva
        $imagenPrincipal = $this->request->getFile('imagen_principal');
        if ($imagenPrincipal && $imagenPrincipal->isValid()) {
            $rules['imagen_principal'] = 'max_size[imagen_principal,5120]|is_image[imagen_principal]';
        }
        
        if (!$this->validate($rules)) {
            return redirect()->back()->withInput()->with('errors', $this->validator->getErrors());
        }
        
        // Procesar nueva imagen principal si se subió
        $nombreImagen = $proyecto['imagen_principal'];
        
        if ($imagenPrincipal && $imagenPrincipal->isValid()) {
            // Eliminar imagen anterior
            if ($nombreImagen && file_exists(WRITEPATH . '../public/uploads/proyectos/' . $nombreImagen)) {
                unlink(WRITEPATH . '../public/uploads/proyectos/' . $nombreImagen);
            }
            
            $nombreImagen = $imagenPrincipal->getRandomName();
            $imagenPrincipal->move(WRITEPATH . '../public/uploads/proyectos', $nombreImagen);
        }
        
        // Actualizar proyecto
        $data = [
            'nombre' => $this->request->getPost('nombre'),
            'imagen_principal' => $nombreImagen,
            'descripcion' => $this->request->getPost('descripcion'),
            'caso_estudio' => $this->request->getPost('caso_estudio'),
            'cliente' => $this->request->getPost('cliente'),
            'anio' => $this->request->getPost('anio')
        ];
        
        if ($this->proyectoModel->update($id, $data)) {
            // Actualizar secciones
            $this->actualizarSecciones($id);
            
            // Actualizar galería
            $this->actualizarGaleria($id);
            
            return redirect()->to('/proyectos')->with('success', 'Proyecto actualizado correctamente');
        }
        
        return redirect()->back()->withInput()->with('error', 'Error al actualizar el proyecto');
    }

    // Continúa en la siguiente parte...
    
    // ==================== CONTINUACIÓN DEL CONTROLADOR ====================
// PARTE 2 - Métodos auxiliares y complementarios del controlador Proyectos

    // Eliminar proyecto
    public function eliminar($id)
    {
        $redirect = $this->verificarAdmin();
        if ($redirect) return $redirect;
        
        $proyecto = $this->proyectoModel->find($id);
        
        if (!$proyecto) {
            return redirect()->to('/proyectos')->with('error', 'Proyecto no encontrado');
        }
        
        // Eliminar imagen principal
        if ($proyecto['imagen_principal'] && file_exists(WRITEPATH . '../public/uploads/proyectos/' . $proyecto['imagen_principal'])) {
            unlink(WRITEPATH . '../public/uploads/proyectos/' . $proyecto['imagen_principal']);
        }
        
        // Eliminar imágenes de secciones
        $secciones = $this->seccionModel->getSecciones($id);
        foreach ($secciones as $seccion) {
            if ($seccion['tipo_media'] == 'imagen' && $seccion['media_url']) {
                $rutaImagen = WRITEPATH . '../public/uploads/proyectos/secciones/' . $seccion['media_url'];
                if (file_exists($rutaImagen)) {
                    unlink($rutaImagen);
                }
            }
        }
        
        // Eliminar imágenes de galería
        $galeria = $this->galeriaModel->getGaleria($id);
        foreach ($galeria as $imagen) {
            $rutaImagen = WRITEPATH . '../public/uploads/proyectos/galeria/' . $imagen['imagen'];
            if (file_exists($rutaImagen)) {
                unlink($rutaImagen);
            }
        }
        
        // Eliminar proyecto (cascade eliminará secciones y galería)
        if ($this->proyectoModel->delete($id)) {
            return redirect()->to('/proyectos')->with('success', 'Proyecto eliminado correctamente');
        }
        
        return redirect()->to('/proyectos')->with('error', 'Error al eliminar el proyecto');
    }
    
    // Guardar secciones de contenido
    private function guardarSecciones($proyectoId)
    {
        $secciones = $this->request->getPost('secciones');
        
        if (!$secciones || !is_array($secciones)) {
            return;
        }
        
        $orden = 1;
        foreach ($secciones as $seccion) {
            $tipoMedia = $seccion['tipo_media'] ?? 'imagen';
            $mediaUrl = null;
            
            // Procesar imagen de la sección si existe
            if ($tipoMedia == 'imagen' && isset($seccion['media_file'])) {
                $file = $this->request->getFile('secciones.' . ($orden - 1) . '.media_file');
                
                if ($file && $file->isValid()) {
                    $mediaUrl = $file->getRandomName();
                    $file->move(WRITEPATH . '../public/uploads/proyectos/secciones', $mediaUrl);
                }
            } elseif ($tipoMedia == 'video') {
                $mediaUrl = $seccion['media_url'] ?? null;
            }
            
            $data = [
                'proyecto_id' => $proyectoId,
                'tipo_media' => $tipoMedia,
                'media_url' => $mediaUrl,
                'contenido' => $seccion['contenido'] ?? '',
                'orden' => $orden++
            ];
            
            $this->seccionModel->insert($data);
        }
    }
    
    // Actualizar secciones de contenido
    private function actualizarSecciones($proyectoId)
    {
        // Obtener IDs de secciones a mantener
        $seccionesIds = $this->request->getPost('secciones_ids') ?? [];
        
        // Eliminar secciones que ya no están
        $seccionesActuales = $this->seccionModel->getSecciones($proyectoId);
        foreach ($seccionesActuales as $seccionActual) {
            if (!in_array($seccionActual['id'], $seccionesIds)) {
                // Eliminar imagen si existe
                if ($seccionActual['tipo_media'] == 'imagen' && $seccionActual['media_url']) {
                    $rutaImagen = WRITEPATH . '../public/uploads/proyectos/secciones/' . $seccionActual['media_url'];
                    if (file_exists($rutaImagen)) {
                        unlink($rutaImagen);
                    }
                }
                $this->seccionModel->delete($seccionActual['id']);
            }
        }
        
        // Procesar secciones (actualizar existentes y crear nuevas)
        $secciones = $this->request->getPost('secciones') ?? [];
        $orden = 1;
        
        foreach ($secciones as $index => $seccion) {
            $seccionId = $seccion['id'] ?? null;
            $tipoMedia = $seccion['tipo_media'] ?? 'imagen';
            $mediaUrl = $seccion['media_url_actual'] ?? null;
            
            // Verificar si hay nueva imagen
            $file = $this->request->getFile('secciones.' . $index . '.media_file');
            
            if ($file && $file->isValid()) {
                // Eliminar imagen anterior si existe
                if ($mediaUrl && $tipoMedia == 'imagen') {
                    $rutaAnterior = WRITEPATH . '../public/uploads/proyectos/secciones/' . $mediaUrl;
                    if (file_exists($rutaAnterior)) {
                        unlink($rutaAnterior);
                    }
                }
                
                $mediaUrl = $file->getRandomName();
                $file->move(WRITEPATH . '../public/uploads/proyectos/secciones', $mediaUrl);
            } elseif ($tipoMedia == 'video') {
                $mediaUrl = $seccion['media_url'] ?? $mediaUrl;
            }
            
            $data = [
                'proyecto_id' => $proyectoId,
                'tipo_media' => $tipoMedia,
                'media_url' => $mediaUrl,
                'contenido' => $seccion['contenido'] ?? '',
                'orden' => $orden++
            ];
            
            if ($seccionId && in_array($seccionId, $seccionesIds)) {
                // Actualizar existente
                $this->seccionModel->update($seccionId, $data);
            } else {
                // Crear nueva
                $this->seccionModel->insert($data);
            }
        }
    }
    
    // Guardar galería de imágenes
    private function guardarGaleria($proyectoId)
    {
        $galeria = $this->request->getFileMultiple('galeria');
        
        if (!$galeria) {
            return;
        }
        
        $orden = 1;
        foreach ($galeria as $file) {
            if ($file->isValid()) {
                $nombreImagen = $file->getRandomName();
                $file->move(WRITEPATH . '../public/uploads/proyectos/galeria', $nombreImagen);
                
                $data = [
                    'proyecto_id' => $proyectoId,
                    'imagen' => $nombreImagen,
                    'orden' => $orden++
                ];
                
                $this->galeriaModel->insert($data);
            }
        }
    }
    
    // Actualizar galería de imágenes
    private function actualizarGaleria($proyectoId)
    {
        // Obtener IDs de imágenes a mantener
        $galeriaIds = $this->request->getPost('galeria_ids') ?? [];
        
        // Eliminar imágenes que ya no están
        $galeriaActual = $this->galeriaModel->getGaleria($proyectoId);
        foreach ($galeriaActual as $imagenActual) {
            if (!in_array($imagenActual['id'], $galeriaIds)) {
                $rutaImagen = WRITEPATH . '../public/uploads/proyectos/galeria/' . $imagenActual['imagen'];
                if (file_exists($rutaImagen)) {
                    unlink($rutaImagen);
                }
                $this->galeriaModel->delete($imagenActual['id']);
            }
        }
        
        // Agregar nuevas imágenes si existen
        $this->guardarGaleria($proyectoId);
    }
    
    // Eliminar imagen de galería específica (AJAX)
    public function eliminarImagenGaleria($id)
    {
        $redirect = $this->verificarAdmin();
        if ($redirect) return $redirect;
        
        $imagen = $this->galeriaModel->find($id);
        
        if (!$imagen) {
            return $this->response->setJSON(['success' => false, 'message' => 'Imagen no encontrada']);
        }
        
        // Eliminar archivo
        $rutaImagen = WRITEPATH . '../public/uploads/proyectos/galeria/' . $imagen['imagen'];
        if (file_exists($rutaImagen)) {
            unlink($rutaImagen);
        }
        
        if ($this->galeriaModel->delete($id)) {
            return $this->response->setJSON(['success' => true, 'message' => 'Imagen eliminada']);
        }
        
        return $this->response->setJSON(['success' => false, 'message' => 'Error al eliminar']);
    }
    
    // Eliminar sección específica (AJAX)
    public function eliminarSeccion($id)
    {
        $redirect = $this->verificarAdmin();
        if ($redirect) return $redirect;
        
        $seccion = $this->seccionModel->find($id);
        
        if (!$seccion) {
            return $this->response->setJSON(['success' => false, 'message' => 'Sección no encontrada']);
        }
        
        // Eliminar archivo si es imagen
        if ($seccion['tipo_media'] == 'imagen' && $seccion['media_url']) {
            $rutaImagen = WRITEPATH . '../public/uploads/proyectos/secciones/' . $seccion['media_url'];
            if (file_exists($rutaImagen)) {
                unlink($rutaImagen);
            }
        }
        
        if ($this->seccionModel->delete($id)) {
            return $this->response->setJSON(['success' => true, 'message' => 'Sección eliminada']);
        }
        
        return $this->response->setJSON(['success' => false, 'message' => 'Error al eliminar']);
    }
/**
 * Subir imagen desde TinyMCE (AJAX)
 */
public function subirImagenTinymce()
{
    // Permitir solo si es admin
    if (!session()->has('usuario_id') || session()->get('usuario_rol') != 'admin') {
        return $this->response->setJSON([
            'error' => 'No autorizado'
        ])->setStatusCode(403);
    }
    
    // Verificar que sea una petición AJAX
    if (!$this->request->isAJAX()) {
        return $this->response->setJSON([
            'error' => 'Petición inválida'
        ])->setStatusCode(400);
    }
    
    // Validar el archivo
    $validation = \Config\Services::validation();
    
    $rules = [
        'file' => 'uploaded[file]|max_size[file,5120]|is_image[file]'
    ];
    
    $messages = [
        'file' => [
            'uploaded' => 'No se recibió ningún archivo',
            'max_size' => 'La imagen es demasiado grande (máximo 5MB)',
            'is_image' => 'El archivo debe ser una imagen'
        ]
    ];
    
    if (!$this->validate($rules, $messages)) {
        $errors = $this->validator->getErrors();
        return $this->response->setJSON([
            'error' => implode(', ', $errors)
        ])->setStatusCode(400);
    }
    
    // Obtener el archivo
    $file = $this->request->getFile('file');
    
    if (!$file || !$file->isValid()) {
        return $this->response->setJSON([
            'error' => 'Archivo inválido o corrupto'
        ])->setStatusCode(400);
    }
    
    // Verificar que no se haya movido ya
    if ($file->hasMoved()) {
        return $this->response->setJSON([
            'error' => 'El archivo ya fue procesado'
        ])->setStatusCode(400);
    }
    
    try {
        // Crear carpeta si no existe
        $uploadPath = WRITEPATH . '../public/uploads/tinymce';
        if (!is_dir($uploadPath)) {
            mkdir($uploadPath, 0755, true);
        }
        
        // Generar nombre único
        $newName = $file->getRandomName();
        
        // Mover archivo
        if ($file->move($uploadPath, $newName)) {
            // Retornar URL de la imagen
            return $this->response->setJSON([
                'location' => base_url('uploads/tinymce/' . $newName)
            ]);
        } else {
            return $this->response->setJSON([
                'error' => 'No se pudo guardar la imagen'
            ])->setStatusCode(500);
        }
        
    } catch (\Exception $e) {
        log_message('error', 'Error subiendo imagen TinyMCE: ' . $e->getMessage());
        return $this->response->setJSON([
            'error' => 'Error del servidor: ' . $e->getMessage()
        ])->setStatusCode(500);
    }
}

}