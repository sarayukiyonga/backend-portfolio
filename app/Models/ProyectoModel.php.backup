<?php

namespace App\Models;

use CodeIgniter\Model;

class ProyectoModel extends Model
{
    protected $table = 'proyectos';
    protected $primaryKey = 'id';
    protected $allowedFields = [
        'nombre', 
        'imagen_principal', 
        'descripcion', 
        'caso_estudio', 
        'cliente', 
        'anio', 
        'orden', 
        'activo',
        'estado',        
        'visibilidad'    
    ];
    protected $useTimestamps = true;
    protected $createdField = 'created_at';
    protected $updatedField = 'updated_at';
    
    protected $validationRules = [
        'nombre' => 'required|min_length[3]|max_length[255]',
        'descripcion' => 'required',
        'anio' => 'permit_empty|integer|min_length[4]|max_length[4]'
    ];
    
    protected $validationMessages = [
        'nombre' => [
            'required' => 'El nombre del proyecto es requerido',
            'min_length' => 'El nombre debe tener al menos 3 caracteres'
        ],
        'descripcion' => [
            'required' => 'La descripción es requerida'
        ]
    ];
    
    // Obtener proyecto completo con secciones y galería
    public function getProyectoCompleto($id)
    {
        $proyecto = $this->find($id);
        
        if (!$proyecto) {
            return null;
        }
        
        // Obtener secciones
        $db = \Config\Database::connect();
        $proyecto['secciones'] = $db->table('proyecto_secciones')
            ->where('proyecto_id', $id)
            ->orderBy('orden', 'ASC')
            ->get()
            ->getResultArray();
        
        // Obtener galería
        $proyecto['galeria'] = $db->table('proyecto_galeria')
            ->where('proyecto_id', $id)
            ->orderBy('orden', 'ASC')
            ->get()
            ->getResultArray();
        
        return $proyecto;
    }
    
    // Listar proyectos activos ordenados
    public function listarProyectosActivos()
    {
        return $this->where('activo', 1)
                    ->orderBy('orden', 'ASC')
                    ->orderBy('created_at', 'DESC')
                    ->findAll();
    }
    
    // Listar todos los proyectos (admin)
    public function listarTodosProyectos()
    {
        return $this->orderBy('orden', 'ASC')
                    ->orderBy('created_at', 'DESC')
                    ->findAll();
    }
}
